name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  CARGO_TERM_COLOR: always
  CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse
  CARGO_NET_GIT_FETCH_WITH_CLI: "true"
  CARGO_HTTP_MULTIPLEXING: "false"
  CARGO_HTTP_TIMEOUT: "600"
  HTTP_PROXY: ""
  HTTPS_PROXY: ""
  ALL_PROXY: ""
  http_proxy: ""
  https_proxy: ""
  all_proxy: ""

jobs:
  test:
    name: Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    env:
      CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@1.81.0
      with:
        components: rustfmt,clippy

    - name: Remove git proxies
      run: |
        git config --global --unset-all http.proxy  || true
        git config --global --unset-all https.proxy || true

    - name: Cache cargo
      uses: Swatinem/rust-cache@v2
      with:
        cache-on-failure: true
        cache-all-crates: true

    - name: Cargo metadata (smoke)
      run: cargo metadata --format-version=1 --locked

    - name: Prime index & fetch (retry)
      run: |
        set -e
        for i in 1 2 3; do
          if [ -f Cargo.lock ]; then
            cargo fetch --locked && break
          else
            cargo fetch && break
          fi
          echo "retry $i…"
          sleep 5
        done

    - name: Build
      run: cargo build --verbose --no-default-features --locked

    - name: Run tests
      run: cargo test --verbose --no-default-features --locked -- --nocapture

    - name: Test packaging
      if: matrix.os == 'ubuntu-latest'
      run: cargo test --no-default-features --features pkg --locked -- --nocapture

    - name: Check formatting
      run: cargo fmt -- --check

    - name: Run clippy
      run: cargo clippy -- -D warnings

  coverage_core:
    name: Coverage (core – no optional features)
    runs-on: ubuntu-latest
    env:
      CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust (stable)
      uses: dtolnay/rust-toolchain@1.81.0

    - name: Remove git proxies
      run: |
        git config --global --unset-all http.proxy  || true
        git config --global --unset-all https.proxy || true

    - name: Cargo metadata (smoke)
      run: cargo metadata --format-version=1 --locked

    - name: Prime index & fetch (retry)
      run: |
        set -e
        for i in 1 2 3; do
          if [ -f Cargo.lock ]; then
            cargo fetch --locked && break
          else
            cargo fetch && break
          fi
          echo "retry $i…"
          sleep 5
        done

    - name: Install tarpaulin
      run: cargo install cargo-tarpaulin

    - name: Generate coverage (no-default-features)
      run: cargo tarpaulin --verbose --no-default-features --workspace --timeout 120 --out Xml

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./cobertura.xml
        fail_ci_if_error: false

  coverage_optional:
    name: Coverage (optional features matrix)
    if: ${{ vars.ENABLE_OPTIONAL_FEATURE_COVERAGE == 'true' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        feature_set:
          - "autodiff"
          - "mlir"
          - "llvm"
          - "mlir,llvm"
          - "autodiff,mlir,llvm"
    env:
      CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust (stable)
      uses: dtolnay/rust-toolchain@1.81.0

    - name: Remove git proxies
      run: |
        git config --global --unset-all http.proxy  || true
        git config --global --unset-all https.proxy || true

    - name: Cargo metadata (smoke)
      run: cargo metadata --format-version=1 --locked

    - name: Prime index & fetch (retry)
      run: |
        set -e
        for i in 1 2 3; do
          if [ -f Cargo.lock ]; then
            cargo fetch --locked && break
          else
            cargo fetch && break
          fi
          echo "retry $i…"
          sleep 5
        done

    - name: Install tarpaulin
      run: cargo install cargo-tarpaulin

    # NOTE: This job assumes the runner/environment already provides any needed toolchains
    # (e.g., LLVM/MLIR). It is OFF by default via repo var gating.
    - name: Generate coverage (features = ${{ matrix.feature_set }})
      run: cargo tarpaulin --verbose --features "${{ matrix.feature_set }}" --workspace --timeout 120 --out Xml

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./cobertura.xml
        fail_ci_if_error: false
  autodiff_tests:
    name: Tests (feature: autodiff)
    runs-on: ubuntu-latest
    env:
      CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.81.0

      - name: Remove git proxies
        run: |
          git config --global --unset-all http.proxy  || true
          git config --global --unset-all https.proxy || true

      - name: Cargo metadata (smoke)
        run: cargo metadata --format-version=1 --locked

      - name: Prime index & fetch (retry)
        run: |
          set -e
          for i in 1 2 3; do
            if [ -f Cargo.lock ]; then
              cargo fetch --locked && break
            else
              cargo fetch && break
            fi
            echo "retry $i…"
            sleep 5
          done
      - name: Run tests (autodiff feature)
        run: cargo test --workspace --all-targets --features autodiff --verbose
  mlir_stub_tests:
    name: Tests (feature: mlir stub)
    runs-on: ubuntu-latest
    env:
      CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.81.0

      - name: Remove git proxies
        run: |
          git config --global --unset-all http.proxy  || true
          git config --global --unset-all https.proxy || true

      - name: Cargo metadata (smoke)
        run: cargo metadata --format-version=1 --locked

      - name: Prime index & fetch (retry)
        run: |
          set -e
          for i in 1 2 3; do
            if [ -f Cargo.lock ]; then
              cargo fetch --locked && break
            else
              cargo fetch && break
            fi
            echo "retry $i…"
            sleep 5
          done
      - name: Run tests (mlir stub)
        run: cargo test --workspace --all-targets --features mlir --verbose

  mlir_build_check:
    name: Check (feature: mlir-build)
    runs-on: ubuntu-latest
    env:
      CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.81.0

      - name: Remove git proxies
        run: |
          git config --global --unset-all http.proxy  || true
          git config --global --unset-all https.proxy || true

      - name: Cargo metadata (smoke)
        run: cargo metadata --format-version=1 --locked

      - name: Prime index & fetch (retry)
        run: |
          set -e
          for i in 1 2 3; do
            if [ -f Cargo.lock ]; then
              cargo fetch --locked && break
            else
              cargo fetch && break
            fi
            echo "retry $i…"
            sleep 5
          done
      - name: Cargo check (mlir-build)
        run: cargo check --no-default-features --features mlir-build --locked

  fmt_check:
    name: Format (rustfmt)
    runs-on: ubuntu-latest
    env:
      CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@1.81.0
        with:
          components: rustfmt
      - name: Remove git proxies
        run: |
          git config --global --unset-all http.proxy  || true
          git config --global --unset-all https.proxy || true
      - name: Cargo metadata (smoke)
        run: cargo metadata --format-version=1 --locked
      - name: Prime index & fetch (retry)
        run: |
          set -e
          for i in 1 2 3; do
            if [ -f Cargo.lock ]; then
              cargo fetch --locked && break
            else
              cargo fetch && break
            fi
            echo "retry $i…"
            sleep 5
          done
      - name: rustfmt version
        run: rustfmt --version
      - name: rustfmt check
        run: cargo fmt --all -- --check

  clippy_core:
    name: Clippy (no-default-features)
    runs-on: ubuntu-latest
    env:
      CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@1.81.0
        with:
          components: clippy
      - name: Remove git proxies
        run: |
          git config --global --unset-all http.proxy  || true
          git config --global --unset-all https.proxy || true
      - name: Cargo metadata (smoke)
        run: cargo metadata --format-version=1 --locked
      - name: Prime index & fetch (retry)
        run: |
          set -e
          for i in 1 2 3; do
            if [ -f Cargo.lock ]; then
              cargo fetch --locked && break
            else
              cargo fetch && break
            fi
            echo "retry $i…"
            sleep 5
          done
      - name: clippy
        run: cargo clippy --workspace --all-targets --no-default-features

  ffi_feature_tests:
    name: Tests (FFI feature matrix)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      matrix:
        include:
          - label: core
            args: "--no-default-features"
          - label: ffi-c
            args: "--no-default-features --features ffi-c"
          - label: ffi-full
            args: "--no-default-features --features \"ffi-c mlir-build cpu-exec ffi-examples\""
    env:
      CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.81.0

      - name: Remove git proxies
        run: |
          git config --global --unset-all http.proxy  || true
          git config --global --unset-all https.proxy || true

      - name: Cargo metadata (smoke)
        run: cargo metadata --format-version=1 --locked

      - name: Prime index & fetch (retry)
        run: |
          set -e
          for i in 1 2 3; do
            if [ -f Cargo.lock ]; then
              cargo fetch --locked && break
            else
              cargo fetch && break
            fi
            echo "retry $i…"
            sleep 5
          done
      - name: Cargo test (${{ matrix.label }})
        run: cargo test --verbose --locked ${{ matrix.args }}

  supply_chain_check:
    name: Supply chain (cargo-deny & audit)
    runs-on: ubuntu-latest
    env:
      CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.81.0

      - name: Remove git proxies
        run: |
          git config --global --unset-all http.proxy  || true
          git config --global --unset-all https.proxy || true

      - name: Cargo metadata (smoke)
        run: cargo metadata --format-version=1 --locked

      - name: Prime index & fetch (retry)
        run: |
          set -e
          for i in 1 2 3; do
            if [ -f Cargo.lock ]; then
              cargo fetch --locked && break
            else
              cargo fetch && break
            fi
            echo "retry $i…"
            sleep 5
          done

      - name: Install tools
        run: |
          cargo install cargo-deny --version ^0.14
          cargo install cargo-audit --version ^0.20

      - name: cargo-deny check (licenses, bans, advisories)
        run: cargo deny check

      - name: cargo-audit (vulns)
        run: cargo audit --quiet

  mlir_jit_check:
    name: Check (feature: mlir-jit)
    if: github.repository_owner == 'cputer'
    runs-on: ubuntu-latest
    continue-on-error: true
    env:
      CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.81.0
      - name: Remove git proxies
        run: |
          git config --global --unset-all http.proxy  || true
          git config --global --unset-all https.proxy || true
      - name: Cargo metadata (smoke)
        run: cargo metadata --format-version=1 --locked
      - name: Prime index & fetch (retry)
        run: |
          set -e
          for i in 1 2 3; do
            if [ -f Cargo.lock ]; then
              cargo fetch --locked && break
            else
              cargo fetch && break
            fi
            echo "retry $i…"
            sleep 5
          done
      - name: cargo check (mlir-jit)
        run: cargo check --no-default-features --features mlir-jit --locked

  mlir_gpu_check:
    name: Check (feature: mlir-gpu)
    if: github.repository_owner == 'cputer'
    runs-on: ubuntu-latest
    continue-on-error: true
    env:
      CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.81.0
      - name: Remove git proxies
        run: |
          git config --global --unset-all http.proxy  || true
          git config --global --unset-all https.proxy || true
      - name: Cargo metadata (smoke)
        run: cargo metadata --format-version=1 --locked
      - name: Prime index & fetch (retry)
        run: |
          set -e
          for i in 1 2 3; do
            if [ -f Cargo.lock ]; then
              cargo fetch --locked && break
            else
              cargo fetch && break
            fi
            echo "retry $i…"
            sleep 5
          done
      - name: cargo check (mlir-gpu)
        run: cargo check --no-default-features --features mlir-gpu --locked
